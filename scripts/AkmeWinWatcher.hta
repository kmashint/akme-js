<!DOCTYPE html >
<html>
<head>
<title>Akme Window Watcher</title>
<meta http-equiv="Content-Type" content="application/hta; charset=windows-1252" />
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<script type="text/javascript">window.moveTo((screen.width-976)/2,(screen.height-720)/2); window.resizeTo(976,720);</script>
<!-- GetObject is not supported in JScript/HTA for IE=9 or higher, use IE=8 or vbs helper before js.
	http://social.technet.microsoft.com/Forums/en-US/ITCG/thread/37246a26-6401-4d3f-87c7-77046e11b8af/
	More on HTA and Windows Scripting Host.
	http://msdn.microsoft.com/en-us/library/ms536496%28v=vs.85%29.aspx
	-->
<hta:application id="HTA"
	applicationName="Akme Window Watcher"
	singleInstance="yes"
	/>
<style>
body { }
#body { }
#inputDiv { float: left; }
#outputDiv { float: right; clear: right; }
#outputFrame { width: 480px; }
#log { clear: both; }
</style>
</head>
<body>
<div id='body'>

<p>Check running services.
</p>
<div id='inputDiv'>
<form name='testForm' onsubmit='return false;'>
  <br/><input type='button' name='findBtn' value='find' />
  <br/><select name='serviceSelect'></select>
  <br/><input type='button' name='startBtn' value='start' />
    <input type='button' name='stopBtn' value='stop' />
    <input type='button' name='clearBtn' value='clearLog' />
  <br/>Status: <input type='text' name='serviceStatus' value='' readonly/>
</form>
</div>

<div id='outputDiv'>
</div>

<div id='log'>
</div>

</div>
<script src="AkmeUtilMicrosoft.js"></script>
<script>
//

this.onload = function() {
  var elem = document.forms['testForm'].elements['serviceSelect'];
  elem.addEventListener('change', Test.selectService);

  elem = document.forms['testForm'].elements['findBtn'];
  elem.addEventListener('click', Test.find);

  elem = document.forms['testForm'].elements['startBtn'];
  elem.addEventListener('click', Test.startService);

  elem = document.forms['testForm'].elements['stopBtn'];
  elem.addEventListener('click', Test.stopService);

  elem = document.forms['testForm'].elements['clearBtn'];
  elem.addEventListener('click', Test.clearLog);
};

var Test = (function() {
	var slice = Array.prototype.slice;

	return {
		find: find,
    selectService: selectService,
    startService: startService,
    stopService: stopService,
    clearLog: clearLog
	};

	function find() {
    clearLog();
    var logDiv = document.getElementById('log');
    var elem = document.forms['testForm'].elements['serviceSelect'];
    elem.options.length = 0;
    // Win32_Service the typical services, Win32_BaseService includes deeper ones.
		for (var en = new Enumerator(AkmeMS.wmiInstancesOf('Win32_Service'));
				!en.atEnd(); en.moveNext()) {
			var item = en.item();
			log(item.Name, item.Description); // key=DeviceID
      var opt = new Option(item.Name, item.Name);
      opt.setAttribute('title', item.Description);
      opt.setAttribute('data-status', (item.Started ? 'Started' : 'Stopped') + ' ' + item.Status);
      elem.appendChild(opt);
		}
	}

  function selectService(evt) {
    var statusElem = document.forms['testForm'].elements['serviceStatus'];
    var evtSelected = evt.target.options[evt.target.selectedIndex];
    statusElem.value = evtSelected.getAttribute('data-status');
  }

  function startService(evt) {
    var elem = document.forms['testForm'].elements['serviceSelect'];
    var statusElem = document.forms['testForm'].elements['serviceStatus'];
    var svcOpt = elem.options[elem.selectedIndex];
    var items = AkmeMS.wmi.ExecQuery('SELECT * FROM Win32_Service WHERE Name=\'' + svcOpt.value + '\'');
    var svc = items.ItemIndex(0);  // new Enumerator(result).item();
    var result = svc.StartService();
    if (result == 0) {
      statusElem.value = 'Started OK';
      svcOpt.setAttribute('data-status', statusElem.value);
    } else {
      statusElem.value = result;
    }
  }

  function stopService(evt) {
    var elem = document.forms['testForm'].elements['serviceSelect'];
    var statusElem = document.forms['testForm'].elements['serviceStatus'];
    var svcOpt = elem.options[elem.selectedIndex];
    var items = AkmeMS.wmi.ExecQuery('SELECT * FROM Win32_Service WHERE Name=\'' + svcOpt.value + '\'');
    var svc = items.ItemIndex(0);  // new Enumerator(result).item();
    var result = svc.StopService();
    if (result == 0) {
      statusElem.value = 'Stopped OK';
      svcOpt.setAttribute('data-status', statusElem.value);
    } else {
      statusElem.value = result;
    }
  }

  function clearLog() {
    var div1 = document.getElementById('log');
    var div2 = div1.cloneNode(false);
    var parent = div1.parentNode;
    parent.replaceChild(div2, div1);
    dev = null;
  }

  function log() {
		var div = document.getElementById('log');
		div.appendChild(document.createTextNode(slice.call(arguments, 0).join(' ')));
		div.appendChild(document.createElement('br'));
	}

})();

</script>
</body>
</html>